---
export interface Props {
  type?: 'spectrum' | 'custom';
  duration?: number;
  autoHide?: boolean;
}

const { 
  type = 'spectrum',
  duration = 2000,
  autoHide = true
} = Astro.props;
---

<!-- Capa de animaci贸n del Spectrum visible desde el principio -->
<div class="spectrum-loader" data-type={type} data-duration={duration} data-auto-hide={autoHide}>
  <div class="spectrum-border-full"></div>
  <div class="spectrum-viewport-mask"></div>
</div>

<style>
  /* Capa de animaci贸n visible desde el principio */
  .spectrum-loader {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    pointer-events: none;
  }

  /* Franjas del Spectrum visibles desde el principio */
  .spectrum-border-full {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      to bottom,
      #ff0000 0%,
      #ff0000 calc(var(--u) * 0.02),
      #00ffff calc(var(--u) * 0.02),
      #00ffff calc(var(--u) * 0.04)
    );
    background-size: calc(var(--u) * 0.08) calc(var(--u) * 0.08);
    animation: stripeMoveFull 0.8s linear infinite;
    z-index: 10;
  }

  /* M谩scara del viewport visible desde el principio */
  .spectrum-viewport-mask {
    position: absolute;
    top: calc(var(--u) * 0.08);
    left: calc(var(--u) * 0.08);
    right: calc(var(--u) * 0.08);
    bottom: calc(var(--u) * 0.08);
    background: #c0c0c0;
    z-index: 20;
  }

  @keyframes stripeMoveFull {
    0% {
      background-position: 0 0;
    }
    25% {
      background-position: 0 calc(var(--u) * 0.08);
    }
    50% {
      background-position: 0 0;
    }
    75% {
      background-position: 0 calc(var(--u) * -0.08);
    }
    100% {
      background-position: 0 0;
    }
  }
</style>

<script>
  class SpectrumLoader {
    private container: HTMLElement;
    private duration: number;
    private autoHide: boolean;
    private loadingSound: HTMLAudioElement | null = null;

    constructor() {
      this.container = document.querySelector('.spectrum-loader') as HTMLElement;
      if (!this.container) return;

      this.duration = parseInt(this.container.dataset.duration || '2000');
      this.autoHide = this.container.dataset.autoHide === 'true';
      
      this.initAudio();
      this.init();
    }

    private initAudio() {
      try {
        // Crear elemento de audio HTML5 simple
        this.loadingSound = new Audio();
        
        // Usar archivo MP3 real del usuario
        this.loadingSound.src = '/sounds/spectrum-loading.mp3';
        this.loadingSound.volume = 0.5;
        
        // Intentar reproducir inmediatamente
        this.loadingSound.play().then(() => {
          console.log(' Sonido de carga del Spectrum iniciado con MP3 real');
        }).catch(error => {
          console.log('HTML5 Audio fall贸:', error);
        });
        
        // Parar el sonido cuando termine la animaci贸n
        setTimeout(() => {
          if (this.loadingSound) {
            this.loadingSound.pause();
            this.loadingSound.currentTime = 0;
            console.log(' Sonido de carga detenido');
          }
        }, this.duration);
        
      } catch (error) {
        console.log('Error al crear HTML5 Audio:', error);
      }
    }

    private init() {
      // La animaci贸n ya est谩 visible desde el principio
      // Solo configurar la ocultaci贸n autom谩tica
      if (this.autoHide) {
        setTimeout(() => {
          this.hide();
        }, this.duration);
      }
    }

    private hide() {
      // Ocultar la capa de animaci贸n con fade-out
      this.container.style.opacity = '0';
      this.container.style.transition = 'opacity 0.3s ease-in-out';
      
      // Remover completamente despu茅s del fade-out
      setTimeout(() => {
        this.container.remove();
      }, 300);
    }

    // M茅todo p煤blico para ocultar manualmente
    public hideManual() {
      this.hide();
    }
  }

  // Inicializar cuando el DOM est茅 listo
  document.addEventListener('DOMContentLoaded', () => {
    new SpectrumLoader();
  });
</script>
