

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cómo manejar con Doctrine los archivos subidos &mdash; symfony-docs-es v1 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="symfony-docs-es v1 documentation" href="../../index.html" />
    <link rel="up" title="Recetario" href="../index.html" />
    <link rel="next" title="Extensiones Doctrine: Timestampable: Sluggable, Translatable, etc." href="common_extensions.html" />
    <link rel="prev" title="Cómo utilizar las migraciones Doctrine" href="migrations.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="common_extensions.html" title="Extensiones Doctrine: Timestampable: Sluggable, Translatable, etc."
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="migrations.html" title="Cómo utilizar las migraciones Doctrine"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">symfony-docs-es v1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Recetario</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="como-manejar-con-doctrine-los-archivos-subidos">
<h1>Cómo manejar con Doctrine los archivos subidos<a class="headerlink" href="#como-manejar-con-doctrine-los-archivos-subidos" title="Permalink to this headline">¶</a></h1>
<p>Manejar el envío de archivos con entidades Doctrine no es diferente a la manipulación de cualquier otra carga de archivo. En otras palabras, eres libre de mover el archivo en tu controlador después de manipular el envío de un formulario. Para ver ejemplos de cómo hacerlo, consulta el <a class="reference internal" href="../../reference/forms/types/file.html"><em>Tipo de campo file</em></a> en la referencia.</p>
<p>Si lo deseas, también puedes integrar la carga de archivos en el ciclo de vida de tu entidad (es decir, creación, actualización y eliminación). En este caso, ya que tu entidad es creada, actualizada y eliminada desde Doctrine, el proceso de carga y remoción de archivos se llevará a cabo de forma automática (sin necesidad de hacer nada en el controlador);</p>
<p>Para que esto funcione, tendrás que hacerte cargo de una serie de detalles, los cuales serán cubiertos en este artículo del recetario.</p>
<div class="section" id="configuracion-basica">
<h2>Configuración básica<a class="headerlink" href="#configuracion-basica" title="Permalink to this headline">¶</a></h2>
<p>En primer lugar, crea una sencilla clase Entidad de Doctrine con la cual trabajar:</p>
<div class="highlight-python"><pre>// src/Acme/DemoBundle/Entity/Document.php
namespace Acme\DemoBundle\Entity;

use Doctrine\ORM\Mapping as ORM;
use Symfony\Component\Validator\Constraints as Assert;

/**
 * @ORM\Entity
 */
class Document
{
    /**
     * @ORM\Id @ORM\Column(type="integer")
     * @ORM\GeneratedValue(strategy="AUTO")
     */
    public $id;

    /**
     * @ORM\Column(type="string", length=255)
     * @Assert\NotBlank
     */
    public $nombre;

    /**
     * @ORM\Column(type="string", length=255, nullable=true)
     */
    public $ruta;

    public function getFullPath()
    {
        return null === $this-&gt;path ? null : $this-&gt;getUploadRootDir().'/'.$this-&gt;path;
    }

    protected function getUploadRootDir()
    {
        // la ruta absoluta al directorio dónde se deben guardar los archivos cargados
        return __DIR__.'/../../../../web/uploads/documents';
    }
}</pre>
</div>
<p>La entidad <tt class="docutils literal"><span class="pre">Documento</span></tt> tiene un nombre y está asociado con un archivo. La propiedad <tt class="docutils literal"><span class="pre">path</span></tt> almacena la ruta relativa al archivo y se persiste en la base de datos.
<tt class="docutils literal"><span class="pre">getFullPath()</span></tt> es un método útil que utiliza el método <tt class="docutils literal"><span class="pre">getUploadRootDir()</span></tt> para devolver la ruta absoluta al archivo.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Si no lo haz hecho, probablemente primero deberías leer el tipo <a class="reference internal" href="../../reference/forms/types/file.html"><em>archivo</em></a> en la documentación para comprender cómo trabaja el proceso de carga básico.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Si estás utilizando anotaciones para especificar tus reglas de anotación (como muestra este ejemplo), asegúrate de que haz habilitado la validación por medio de anotaciones (consulta <a class="reference internal" href="../../book/validation.html#book-validation-configuration"><em>configurando la validación</em></a>).</p>
</div>
<p>Para manejar el archivo subido real en el formulario, utiliza un campo <tt class="docutils literal"><span class="pre">file</span></tt> &#8220;virtual&#8221;.
Por ejemplo, si estás construyendo tu formulario directamente en un controlador, podría tener este aspecto:</p>
<div class="highlight-python"><pre>public function uploadAction()
{
    // ...

    $formulario = $this-&gt;createFormBuilder($document)
        -&gt;add('nombre')
        -&gt;add('file')
        -&gt;getForm()
    ;

    // ...
}</pre>
</div>
<p>A continuación, crea esta propiedad en tu clase <tt class="docutils literal"><span class="pre">Documento</span></tt> y agrega algunas reglas de validación:</p>
<div class="highlight-python"><pre>// src/Acme/DemoBundle/Entity/Document.php

// ...
class Document
{
    /**
     * @Assert\File(maxSize="6000000")
     */
    public $file;

    // ...
}</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Debido a que estás utilizando la restricción <tt class="docutils literal"><span class="pre">File</span></tt>, Symfony2 automáticamente supone que el campo del formulario es una entrada de carga archivo. Es por eso que no lo tienes que establecer explícitamente al crear el formulario anterior (<tt class="docutils literal"><span class="pre">-&gt;add('file')</span></tt>).</p>
</div>
<p>El siguiente controlador muestra cómo manipular todo el proceso:</p>
<div class="highlight-python"><pre>use Acme\DemoBundle\Entity\Document;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;
// ...

/**
 * @Template()
 */
public function uploadAction()
{
    $document = new Document();
    $formulario = $this-&gt;createFormBuilder($document)
        -&gt;add('nombre')
        -&gt;add('file')
        -&gt;getForm()
    ;

    if ($this-&gt;getRequest()-&gt;getMethod() === 'POST') {
        $formulario-&gt;bindRequest($this-&gt;getRequest());
        if ($formulario-&gt;isValid()) {
            $em = $this-&gt;getDoctrine()-&gt;getEntityManager();

            $em-&gt;persist($document);
            $em-&gt;flush();

            $this-&gt;redirect($this-&gt;generateUrl('...'));
        }
    }

    return array('form' =&gt; $formulario-&gt;createView());
}</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Al escribir la plantilla, no olvides fijar el atributo <tt class="docutils literal"><span class="pre">enctype</span></tt>:</p>
<div class="last highlight-html+php"><pre>&lt;h1&gt;Subir Archivo&lt;/h1&gt;

&lt;form action="#" method="post" {{ form_enctype(form) }}&gt;
    {{ form_widget(form) }}

    &lt;input type="submit" value="Cargar Documento" /&gt;
&lt;/form&gt;</pre>
</div>
</div>
<p>El controlador anterior automáticamente persistirá la entidad <tt class="docutils literal"><span class="pre">Documento</span></tt> con el nombre presentado, pero no hará nada sobre el archivo y la propiedad <tt class="docutils literal"><span class="pre">path</span></tt> quedará en blanco.</p>
<p>Una manera fácil de manejar la carga de archivos es que lo muevas justo antes de que se persista la entidad y a continuación, establece la propiedad <tt class="docutils literal"><span class="pre">path</span></tt> en consecuencia. Comienza por invocar a un nuevo método <tt class="docutils literal"><span class="pre">upload()</span></tt> en la clase <tt class="docutils literal"><span class="pre">Documento</span></tt>, el cual deberás crear en un momento para manejar la carga del archivo:</p>
<div class="highlight-python"><pre>if ($formulario-&gt;isValid()) {
    $em = $this-&gt;getDoctrine()-&gt;getEntityManager();

    $document-&gt;upload();

    $em-&gt;persist($document);
    $em-&gt;flush();

    $this-&gt;redirect('...');
}</pre>
</div>
<p>El método <tt class="docutils literal"><span class="pre">upload()</span></tt> tomará ventaja del objeto <tt class="xref py py-class docutils literal"><span class="pre">Symfony\Component\HttpFoundation\File\UploadedFile</span></tt>, el cual es lo que devuelve después de que se presenta un campo <tt class="docutils literal"><span class="pre">file</span></tt>:</p>
<div class="highlight-python"><pre>public function upload()
{
    // la propiedad 'file' puede estar vacía si el campo no es obligatorio
    if (null === $this-&gt;file) {
        return;
    }

    // aquí utilizamos el nombre de archivo original pero lo deberías
    // desinfectar por lo menos para evitar cualquier problema de seguridad

    // 'move' toma el directorio y nombre de archivo destino al cual trasladarlo
    $this-&gt;file-&gt;move($this-&gt;getUploadRootDir(), $this-&gt;file-&gt;getClientOriginalName());

    // fija la propiedad 'path' al nombre de archivo donde se guardó el archivo
    $this-&gt;setPath($this-&gt;file-&gt;getClientOriginalName());

    // limpia la propiedad 'file' puesto que ya no la vas a necesitar
    unset($this-&gt;file);
}</pre>
</div>
</div>
<div class="section" id="usando-el-ciclo-de-vida-de-las-retrollamadas">
<h2>Usando el ciclo de vida de las retrollamadas<a class="headerlink" href="#usando-el-ciclo-de-vida-de-las-retrollamadas" title="Permalink to this headline">¶</a></h2>
<p>Incluso si esta implementación trabaja, adolece de un defecto importante: ¿Qué pasa si hay un problema al persistir la entidad? El archivo ya se ha movido a su ubicación final, incluso aunque la propiedad <tt class="docutils literal"><span class="pre">path</span></tt> de la entidad no se persista correctamente.</p>
<p>Para evitar estos problemas, debes cambiar la implementación para que la operación de base de datos y el traslado del archivo sean atómicos: si hay un problema al persistir la entidad o si el archivo no se puede mover, entonces, no debe suceder <em>nada</em>.</p>
<p>Para ello, es necesario mover el archivo justo cuando Doctrine persista la entidad a la base de datos. Esto se puede lograr enganchando el ciclo de vida de la entidad a una retrollamada:</p>
<div class="highlight-python"><pre>/**
 * @ORM\Entity
 * @ORM\HasLifecycleCallbacks
 */
class Document
{
}</pre>
</div>
<p>A continuación, reconstruye la clase <tt class="docutils literal"><span class="pre">Documento</span></tt> para que tome ventaja de estas retrollamadas:</p>
<div class="highlight-python"><pre>use Symfony\Component\HttpFoundation\File\UploadedFile;

/**
 * @ORM\Entity
 * @ORM\HasLifecycleCallbacks
 */
class Document
{
    /**
     * @ORM\PrePersist()
     */
    public function preUpload()
    {
        if (null !== $this-&gt;file) {
            // haz lo que quieras para generar un nombre único
            $this-&gt;setPath(uniq().'.'.$this-&gt;file-&gt;guessExtension());
        }
    }

    /**
     * @ORM\PostPersist()
     */
    public function upload()
    {
        if (null === $this-&gt;file) {
            return;
        }

        // aquí debes lanzar una excepción si el archivo no se puede mover
        // para que la entidad no se persista en la base de datos
        // lo cual hace automáticamente el método move() del archivo subido
        $this-&gt;file-&gt;move($this-&gt;getUploadRootDir(), $this-&gt;path);

        unset($this-&gt;file);
    }

    /**
     * @ORM\PostRemove()
     */
    public function removeUpload()
    {
        if ($file = $this-&gt;getFullPath()) {
            unlink($file);
        }
    }
}</pre>
</div>
<p>La clase ahora hace todo lo que necesitas: genera un nombre de archivo único antes de persistirlo, mueve el archivo después de persistirlo y elimina el archivo si la entidad es eliminada.</p>
</div>
<div class="section" id="usando-el-id-como-nombre-de-archivo">
<h2>Usando el <tt class="docutils literal"><span class="pre">id</span></tt> como nombre de archivo<a class="headerlink" href="#usando-el-id-como-nombre-de-archivo" title="Permalink to this headline">¶</a></h2>
<p>Si deseas utilizar el <tt class="docutils literal"><span class="pre">id</span></tt> como el nombre del archivo, la implementación es un poco diferente conforme sea necesaria para guardar la extensión en la propiedad <tt class="docutils literal"><span class="pre">path</span></tt>, en lugar del nombre de archivo real:</p>
<div class="highlight-python"><pre>use Symfony\Component\HttpFoundation\File\UploadedFile;

/**
 * @ORM\Entity
 * @ORM\HasLifecycleCallbacks
 */
class Document
{
    /**
     * @ORM\PrePersist()
     */
    public function preUpload()
    {
        if (null !== $this-&gt;file) {
            $this-&gt;setPath($this-&gt;file-&gt;guessExtension());
        }
    }

    /**
     * @ORM\PostPersist()
     */
    public function upload()
    {
        if (null === $this-&gt;file) {
            return;
        }

        // aquí debes lanzar una excepción si el archivo no se puede mover
        // para que la entidad no se conserve en la base de datos
        // lo cual hace el método move() del archivo subido
        $this-&gt;file-&gt;move($this-&gt;getUploadRootDir(), $this-&gt;id.'.'.$this-&gt;file-&gt;guessExtension());

        unset($this-&gt;file);
    }

    /**
     * @ORM\PostRemove()
     */
    public function removeUpload()
    {
        if ($file = $this-&gt;getFullPath()) {
            unlink($file);
        }
    }

    public function getFullPath()
    {
        return null === $this-&gt;path ? null : $this-&gt;getUploadRootDir().'/'.$this-&gt;id.'.'.$this-&gt;path;
    }
}</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cómo manejar con Doctrine los archivos subidos</a><ul>
<li><a class="reference internal" href="#configuracion-basica">Configuración básica</a></li>
<li><a class="reference internal" href="#usando-el-ciclo-de-vida-de-las-retrollamadas">Usando el ciclo de vida de las retrollamadas</a></li>
<li><a class="reference internal" href="#usando-el-id-como-nombre-de-archivo">Usando el <tt class="docutils literal"><span class="pre">id</span></tt> como nombre de archivo</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="migrations.html"
                        title="previous chapter">Cómo utilizar las migraciones Doctrine</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="common_extensions.html"
                        title="next chapter">Extensiones Doctrine: <tt class="docutils literal docutils literal docutils literal"><span class="pre">Timestampable</span></tt>: <tt class="docutils literal docutils literal docutils literal"><span class="pre">Sluggable</span></tt>, <tt class="docutils literal docutils literal docutils literal"><span class="pre">Translatable</span></tt>, etc.</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/cookbook/doctrine/file_uploads.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="common_extensions.html" title="Extensiones Doctrine: Timestampable: Sluggable, Translatable, etc."
             >next</a> |</li>
        <li class="right" >
          <a href="migrations.html" title="Cómo utilizar las migraciones Doctrine"
             >previous</a> |</li>
        <li><a href="../../index.html">symfony-docs-es v1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Osukaru.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>