

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cómo utilizar las migraciones Doctrine &mdash; symfony-docs-es v1 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="symfony-docs-es v1 documentation" href="../../index.html" />
    <link rel="up" title="Recetario" href="../index.html" />
    <link rel="next" title="Cómo manejar con Doctrine los archivos subidos" href="file_uploads.html" />
    <link rel="prev" title="Cómo utilizar MongoDB" href="mongodb.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="file_uploads.html" title="Cómo manejar con Doctrine los archivos subidos"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mongodb.html" title="Cómo utilizar MongoDB"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">symfony-docs-es v1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Recetario</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="como-utilizar-las-migraciones-doctrine">
<span id="index-0"></span><h1>Cómo utilizar las migraciones Doctrine<a class="headerlink" href="#como-utilizar-las-migraciones-doctrine" title="Permalink to this headline">¶</a></h1>
<p>La funcionalidad migración de base de datos, es una extensión de la capa de abstracción de bases de datos y te ofrece la posibilidad de desplegar programáticamente nuevas versiones del esquema de la base de datos de forma segura y estandarizada.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Puedes leer más sobre las migraciones de base de datos de Doctrine en la <a class="reference external" href="http://www.doctrine-project.org/projects/migrations/2.0/docs/reference/introduction/en">documentación</a> del proyecto.</p>
</div>
<div class="section" id="instalando">
<h2>Instalando<a class="headerlink" href="#instalando" title="Permalink to this headline">¶</a></h2>
<p>Las migraciones de Doctrine para Symfony se mantienen en el <a class="reference external" href="https://github.com/symfony/DoctrineMigrationsBundle">DoctrineMigrationsBundle</a>.
Asegúrate de que tienes configuradas en tu proyecto ambas bibliotecas <tt class="docutils literal"><span class="pre">doctrine-migrations</span></tt> y <tt class="docutils literal"><span class="pre">DoctrineMigrationsBundle</span></tt>. Sigue estos pasos para instalar las bibliotecas en la distribución estándar de Symfony.</p>
<p>Agrega lo siguiente a <tt class="docutils literal"><span class="pre">deps</span></tt>. Esto registrará el paquete Migraciones y la biblioteca <em>doctrine-migrations</em> como dependencias en tu aplicación:</p>
<div class="highlight-text"><div class="highlight"><pre>[doctrine-migrations]
    git=http://github.com/doctrine/migrations.git

[DoctrineMigrationsBundle]
    git=http://github.com/symfony/DoctrineMigrationsBundle.git
    target=/bundles/Symfony/Bundle/DoctrineMigrationsBundle
</pre></div>
</div>
<p>Actualiza las bibliotecas de proveedores:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php bin/vendors install
</pre></div>
</div>
<p>A continuación, asegúrate de que el nuevo espacio de nombres <tt class="docutils literal"><span class="pre">Doctrine\DBAL\Migrations</span></tt> se carga automáticamente a través de <tt class="docutils literal"><span class="pre">autoload.php</span></tt>. El nuevo espacio de nombres Migraciones <em>debe</em> estar colocado encima de la entrada <tt class="docutils literal"><span class="pre">Doctrine\\DBAL</span></tt> de manera que el cargador automático vea dentro del directorio migraciones de esas clases:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// app/autoload.php</span>
<span class="x">$loader-&gt;registerNamespaces(array(</span>
<span class="x">    //...</span>
<span class="x">    &#39;Doctrine\\DBAL\\Migrations&#39; =&gt; __DIR__.&#39;/../vendor/doctrine-migrations/lib&#39;,</span>
<span class="x">    &#39;Doctrine\\DBAL&#39;             =&gt; __DIR__.&#39;/../vendor/doctrine-dbal/lib&#39;,</span>
<span class="x">));</span>
</pre></div>
</div>
<p>Por último, asegúrate de activar el paquete en <tt class="docutils literal"><span class="pre">AppKernel.php</span></tt> incluyendo lo siguiente:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// app/AppKernel.php</span>
<span class="x">public function registerBundles()</span>
<span class="x">{</span>
<span class="x">    $bundles = array(</span>
<span class="x">        //...</span>
<span class="x">        new Symfony\Bundle\DoctrineMigrationsBundle\DoctrineMigrationsBundle(),</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
</div>
<div class="section" id="utilizando">
<h2>Utilizando<a class="headerlink" href="#utilizando" title="Permalink to this headline">¶</a></h2>
<p>Toda la funcionalidad de las migraciones se encuentra en unas cuantas ordenes de consola:</p>
<div class="highlight-bash"><div class="highlight"><pre>doctrine:migrations
  :diff     Genera una migración comparando tu base de datos actual
            a tu información asignada.
  :execute  Ejecuta manualmente una sola versión de migración hacia
            arriba o abajo.
  :generate Genera una clase de migración en blanco.
  :migrate  Executa una migración a una versión especificada o la
            última versión disponible.
  :status   Ve el estado de un conjunto de migraciones.
  :version  Añade y elimina versiones de migración manualmente desde
            la tabla de versiones.
</pre></div>
</div>
<p>Empieza consiguiendo la situación de las migraciones en tu aplicación ejecutando la orden <tt class="docutils literal"><span class="pre">status</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:status

 <span class="o">==</span> Configuración

    &gt;&gt; Nombre:                                 Migraciones de HolaBundle
    &gt;&gt; Fuente de configuración:                configurado manualmente
    &gt;&gt; Nombre de la tabla de versión:          hola_bundle_migration_versions
    &gt;&gt; Espacio de nombres de las migraciones:  Application<span class="se">\M</span>igrations
    &gt;&gt; Directorio de las migraciones:          ruta/a/symfony-sandbox/app/DoctrineMigrations
    &gt;&gt; Versión actual:                         0
    &gt;&gt; Última versión:                         0
    &gt;&gt; Migraciones realizadas:                 0
    &gt;&gt; Migraciones disponibles:                0
    &gt;&gt; Nuevas Migraciones:                     0
</pre></div>
</div>
<p>Ahora, podemos empezar a trabajar con las migraciones generando una nueva clase de migración en blanco: Más adelante, aprenderás cómo Doctrine puede generar migraciones automáticamente.</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:generate
Nueva clase migración generada para <span class="s2">&quot;/ruta/al/proyecto/app/DoctrineMigrations/Version20100621140655.php&quot;</span>
</pre></div>
</div>
<p>Echa un vistazo a la clase migración recién generada y verás algo como lo siguiente:</p>
<div class="highlight-python"><pre>namespace Application\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

class Version20100621140655 extends AbstractMigration
{
    public function up(Schema $schema)
    {

    }

    public function down(Schema $schema)
    {

    }
}</pre>
</div>
<p>Si ejecutas la orden <tt class="docutils literal"><span class="pre">status</span></tt> ahora te mostrará que tiene una nueva migración por ejecutar:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:status

 <span class="o">==</span> Configuración

   &gt;&gt; Nombre:                                 Aplicación de migraciones
   &gt;&gt; Fuente de configuración:                configurado manualmente
   &gt;&gt; Nombre de la tabla de versión:          migration_versions
   &gt;&gt; Espacio de nombres de las migraciones:  Application<span class="se">\M</span>igrations
   &gt;&gt; Directorio de las migraciones:          /ruta/al/proyecto/app/DoctrineMigrations
   &gt;&gt; Versión actual:                         0
   &gt;&gt; Última versión:                         2011-06-21 14:06:55 <span class="o">(</span>20100621140655<span class="o">)</span>
   &gt;&gt; Migraciones realizadas:                 0
   &gt;&gt; Migraciones disponibles:                1
   &gt;&gt; Nuevas Migraciones:                     <span class="nv">1</span>

<span class="o">==</span> Versión de migración

   &gt;&gt; 2011-06-21 14:06:55 <span class="o">(</span>20110621140655<span class="o">)</span>           no migrada
</pre></div>
</div>
<p>Ahora puedes agregar algo de código de migración a los métodos <tt class="docutils literal"><span class="pre">up()</span></tt> y <tt class="docutils literal"><span class="pre">down()</span></tt>, y finalmente cuando estés listo migrar:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>Para más información sobre cómo escribir migraciones en sí mismas (es decir, la manera de rellenar los métodos <tt class="docutils literal"><span class="pre">up()</span></tt> y <tt class="docutils literal"><span class="pre">down()</span></tt>), consulta la <a class="reference external" href="http://www.doctrine-project.org/projects/migrations/2.0/docs/reference/introduction/en">documentación</a> oficial de las Migraciones de Doctrine.</p>
<div class="section" id="ejecutando-migraciones-durante-la-implantacion">
<h3>Ejecutando migraciones durante la implantación<a class="headerlink" href="#ejecutando-migraciones-durante-la-implantacion" title="Permalink to this headline">¶</a></h3>
<p>Por supuesto, el objetivo final de la escritura de migraciones es poder utilizarlas para actualizar de forma fiable la estructura de tu base de datos cuando implantes tu aplicación.
Al ejecutar localmente las migraciones (o en un servidor beta), puedes asegurarte de que las migraciones trabajan según lo previsto.</p>
<p>Cuando finalmente emplees tu aplicación, sólo tienes que recordar ejecutar la orden <tt class="docutils literal"><span class="pre">doctrine:migrations:migrate</span></tt>. Internamente, Doctrine crea una tabla <tt class="docutils literal"><span class="pre">migration_versions</span></tt> dentro de la base de datos y lleva a cabo el seguimiento de las migraciones que se han ejecutado allí. Por lo tanto, no importa cuantas migraciones hayas creado y ejecutado localmente, cuando se ejecuta la orden durante la implantación, Doctrine sabrá exactamente qué migraciones no se han ejecutado todavía mirando la tabla <tt class="docutils literal"><span class="pre">migration_versions</span></tt> de tu base de datos de producción. Independientemente de qué servidor esté activado, siempre puedes ejecutar esta orden de forma segura para realizar sólo las migraciones que todavía no se han llevado a cabo en <em>esa</em> base de datos particular.</p>
</div>
</div>
<div class="section" id="generando-migraciones-automaticamente">
<h2>Generando migraciones automáticamente<a class="headerlink" href="#generando-migraciones-automaticamente" title="Permalink to this headline">¶</a></h2>
<p>En realidad, no deberías tener que escribir migraciones manualmente, puesto que la biblioteca de migraciones puede generar las clases de la migración automáticamente comparando tu información asignada a Doctrine (es decir, cómo se <em>debe</em> ver tu base de datos) con la estructura de la base de datos actual.</p>
<p>Por ejemplo, supongamos que creas una nueva entidad <tt class="docutils literal"><span class="pre">User</span></tt> y agregas información asignándola al ORM Doctrine:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="highlight-php-annotations"><pre>// src/Acme/HolaBundle/Entity/Usuario.php
namespace Acme\HolaBundle\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 * @ORM\Table(name="hola_user")
 */
class Usuario
{
    /**
     * @ORM\Id
     * @ORM\Column(type="integer")
     * @ORM\GeneratedValue(strategy="AUTO")
     */
    protected $id;

    /**
     * @ORM\Column(type="string", length="255")
     */
    protected $nombre;
}</pre>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/HolaBundle/Resources/config/doctrine/User.orm.yml</span>
<span class="l-Scalar-Plain">Acme\HolaBundle\Entity\User</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hola_user</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">integer</span>
            <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">strategy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTO</span>
    <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
            <span class="l-Scalar-Plain">length</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">255</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/HolaBundle/Resources/config/doctrine/User.orm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://doctrine-project.org/schemas/orm/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Acme\HolaBundle\Entity\User&quot;</span> <span class="na">table=</span><span class="s">&quot;hola_user&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">length=</span><span class="s">&quot;255&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>

<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Con esta información, Doctrine ya está listo para ayudarte a persistir tu nuevo objeto <tt class="docutils literal"><span class="pre">User</span></tt> a y desde la tabla <tt class="docutils literal"><span class="pre">hola_user</span></tt>. Por supuesto, ¡esta tabla no existe aún! Genera una nueva migración para esta tabla automáticamente ejecutando la siguiente orden:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:diff
</pre></div>
</div>
<p>Deberás ver un mensaje informado que se ha generado una nueva clase migración basada en las diferencias del esquema. Si abres ese archivo, encontrarás que tiene el código SQL necesario para crear la tabla <tt class="docutils literal"><span class="pre">hola_user</span></tt>. A continuación, ejecuta la migración para agregar la tabla a la base de datos:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>La moraleja de la historia es la siguiente: después de cada cambio que realices en tu información de asignación a Doctrine, ejecuta la orden <tt class="docutils literal"><span class="pre">doctrine:migrations:diff</span></tt> para generar automáticamente las clases de la migración.</p>
<p>Si lo haces desde el principio de tu proyecto (es decir, de modo que incluso las primeras tablas fueran cargadas a través de una clase migración), siempre podrás crear una base de datos actualizada y ejecutar las migraciones a fin de tener tu esquema de base de datos totalmente actualizado. De hecho, se trata de un flujo de trabajo fácil y confiable para tu proyecto.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cómo utilizar las migraciones Doctrine</a><ul>
<li><a class="reference internal" href="#instalando">Instalando</a></li>
<li><a class="reference internal" href="#utilizando">Utilizando</a><ul>
<li><a class="reference internal" href="#ejecutando-migraciones-durante-la-implantacion">Ejecutando migraciones durante la implantación</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generando-migraciones-automaticamente">Generando migraciones automáticamente</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mongodb.html"
                        title="previous chapter">Cómo utilizar MongoDB</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="file_uploads.html"
                        title="next chapter">Cómo manejar con Doctrine los archivos subidos</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/cookbook/doctrine/migrations.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="file_uploads.html" title="Cómo manejar con Doctrine los archivos subidos"
             >next</a> |</li>
        <li class="right" >
          <a href="mongodb.html" title="Cómo utilizar MongoDB"
             >previous</a> |</li>
        <li><a href="../../index.html">symfony-docs-es v1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Osukaru.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>